<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Tree Traversal Visualizer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Stack Animation */
        .stack-frame {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: bottom center;
        }
        
        .stack-enter {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        
        .stack-active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Node Pulse Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .node-current {
            animation: pulse-red 2s infinite;
        }

        /* Code Highlight Transition */
        .code-line {
            transition: background-color 0.2s, border-left-width 0.1s;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 h-16 flex items-center justify-between px-8 flex-shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center text-white font-bold font-mono">
                &lt;/&gt;
            </div>
            <h1 class="text-xl font-bold text-slate-100 hidden md:block">Tree Traversal Visualizer</h1>
        </div>
        
        <!-- Mode Switcher -->
        <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
            <button onclick="setMode('preorder')" id="btn-mode-preorder" class="px-4 py-1.5 rounded text-sm font-medium transition text-slate-400 hover:text-white">PreOrder</button>
            <button onclick="setMode('inorder')" id="btn-mode-inorder" class="px-4 py-1.5 rounded text-sm font-medium transition bg-slate-700 text-white shadow-sm">InOrder</button>
            <button onclick="setMode('postorder')" id="btn-mode-postorder" class="px-4 py-1.5 rounded text-sm font-medium transition text-slate-400 hover:text-white">PostOrder</button>
        </div>

        <div class="hidden md:flex items-center gap-4 text-sm text-slate-400">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-red-500 rounded-full"></span> Current
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span> Printed
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-0 overflow-hidden">
        
        <!-- LEFT COLUMN: CODE (3 cols) -->
        <section class="lg:col-span-4 bg-slate-900 border-r border-slate-700 flex flex-col h-full">
            <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider mb-1">Source Code</h2>
                    <p class="text-xs text-slate-500" id="code-label">C++ InOrder Implementation</p>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-4 font-mono text-sm leading-relaxed" id="code-container">
                <!-- Code Lines Generated by JS -->
            </div>

            <!-- Explanation Box -->
            <div class="h-48 bg-slate-800 border-t border-slate-700 p-5 flex flex-col">
                <h3 class="text-xs font-bold text-yellow-500 uppercase mb-2">System Status</h3>
                <p id="explanation-text" class="text-slate-300 text-sm leading-6">
                    Ready to start visualization.
                </p>
            </div>
        </section>

        <!-- MIDDLE COLUMN: TREE (5 cols) -->
        <section class="lg:col-span-5 bg-slate-900 relative flex flex-col h-full">
            <div class="p-4 absolute top-0 left-0 z-10 w-full flex justify-between">
                <div>
                    <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Visual Tree</h2>
                    <p class="text-xs text-slate-500">Structure: 1 &rarr; (2 &rarr; (4, 5)), 3</p>
                </div>
            </div>

            <!-- Visual Canvas -->
            <div class="flex-1 flex items-center justify-center relative bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]">
                
                <!-- SVG Connections -->
                <svg class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 0;">
                    <line x1="50%" y1="15%" x2="30%" y2="40%" stroke="#475569" stroke-width="2" />
                    <line x1="50%" y1="15%" x2="70%" y2="40%" stroke="#475569" stroke-width="2" />
                    <line x1="30%" y1="40%" x2="15%" y2="65%" stroke="#475569" stroke-width="2" />
                    <line x1="30%" y1="40%" x2="45%" y2="65%" stroke="#475569" stroke-width="2" />
                </svg>

                <!-- Nodes -->
                <div id="node-1" class="absolute top-[15%] left-[50%] -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300">1</div>
                <div id="node-2" class="absolute top-[40%] left-[30%] -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300">2</div>
                <div id="node-3" class="absolute top-[40%] left-[70%] -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300">3</div>
                <div id="node-4" class="absolute top-[65%] left-[15%] -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300">4</div>
                <div id="node-5" class="absolute top-[65%] left-[45%] -translate-x-1/2 -translate-y-1/2 w-14 h-14 bg-slate-800 border-2 border-slate-600 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300">5</div>

                <!-- Ghost Nodes (Simplified) -->
                <div id="ghost-4-left" class="opacity-0 transition-opacity absolute top-[80%] left-[5%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
                <div id="ghost-4-right" class="opacity-0 transition-opacity absolute top-[80%] left-[25%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
                <div id="ghost-5-left" class="opacity-0 transition-opacity absolute top-[80%] left-[35%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
                <div id="ghost-5-right" class="opacity-0 transition-opacity absolute top-[80%] left-[55%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
                <div id="ghost-3-left" class="opacity-0 transition-opacity absolute top-[55%] left-[60%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
                <div id="ghost-3-right" class="opacity-0 transition-opacity absolute top-[55%] left-[80%] -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-transparent border border-dashed border-slate-700 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-mono">null</div>
            
            </div>

            <!-- Console Output -->
            <div class="h-32 bg-black border-t border-slate-700 p-4 font-mono text-sm">
                <div class="text-slate-500 text-xs mb-1 border-b border-slate-800 pb-1">Console Output</div>
                <div id="console-output" class="text-green-400 mt-2 flex gap-2 flex-wrap">
                    <span class="animate-pulse">_</span>
                </div>
            </div>
        </section>

        <!-- RIGHT COLUMN: STACK (3 cols) -->
        <section class="lg:col-span-3 bg-slate-800 border-l border-slate-700 flex flex-col h-full shadow-2xl relative">
            <div class="p-4 border-b border-slate-700 bg-slate-800 z-10">
                <h2 class="text-sm font-bold text-purple-400 uppercase tracking-wider mb-1">Call Stack</h2>
                <p class="text-xs text-slate-500">LIFO: Last In, First Out</p>
            </div>

            <!-- Stack Container -->
            <div class="flex-1 p-4 overflow-y-auto flex flex-col-reverse justify-start gap-3 bg-slate-900/50" id="stack-container">
                <!-- Stack frames injected here -->
            </div>

            <!-- Controls -->
            <div class="p-4 border-t border-slate-700 bg-slate-800 flex flex-col gap-3">
                <div class="flex items-center justify-between text-xs text-slate-400 mb-1">
                    <span>Progress</span>
                    <span id="step-counter">0 / 0</span>
                </div>
                <!-- Progress Bar -->
                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                </div>
                
                <div class="flex gap-2 mt-2">
                    <button id="btn-prev" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-backward-step"></i> Prev
                    </button>
                    <button id="btn-next" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-medium transition shadow-lg shadow-blue-900/50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next <i class="fa-solid fa-forward-step"></i>
                    </button>
                    <button id="btn-reset" class="w-12 bg-red-900/80 hover:bg-red-800 text-red-100 py-2 rounded text-sm font-medium transition" title="Reset">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- DATA DATA ---

        const codes = {
            inorder: [
                "void InOrder(Node* temp) {",
                "    if(temp == nullptr) return;",
                "    InOrder(temp->left);",
                "    cout << temp->data << \" \";",
                "    InOrder(temp->right);",
                "}"
            ],
            preorder: [
                "void PreOrder(Node* temp) {",
                "    if(temp == nullptr) return;",
                "    cout << temp->data << \" \";",
                "    PreOrder(temp->left);",
                "    PreOrder(temp->right);",
                "}"
            ],
            postorder: [
                "void PostOrder(Node* temp) {",
                "    if(temp == nullptr) return;",
                "    PostOrder(temp->left);",
                "    PostOrder(temp->right);",
                "    cout << temp->data << \" \";",
                "}"
            ]
        };

        const stepsInOrder = [
             // START 1
            { line: 0, stack: [{f:"In", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Start at Root (1)." },
            { line: 1, stack: [{f:"In", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Is 1 null? No." },
            { line: 2, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Running"}], nodes: {1:"default", 2:"current"}, ghosts:[], output:[], text: "Call Left -> InOrder(2)." },
            // NODE 2
            { line: 1, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Running"}], nodes: {1:"default", 2:"current"}, ghosts:[], output:[], text: "Is 2 null? No." },
            { line: 2, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:[], text: "Call Left -> InOrder(4)." },
            // NODE 4 (Leaf)
            { line: 1, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:[], text: "Is 4 null? No." },
            { line: 2, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Paused (L2)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:["ghost-4-left"], output:[], text: "4 calls Left (null). Return." },
            { line: 3, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:["4"], text: "Print 4." },
            { line: 4, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Paused (L4)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"visited"}, ghosts:["ghost-4-right"], output:["4"], text: "4 calls Right (null). Return." },
            { line: 5, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L2)"},{f:"In", a:"4", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"visited"}, ghosts:[], output:["4"], text: "Node 4 Done. Pop." },
            // BACK TO 2
            { line: 3, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Running"}], nodes: {1:"default", 2:"current", 4:"visited"}, ghosts:[], output:["4", "2"], text: "Back to 2. Print 2." },
            { line: 4, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Running"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["4", "2"], text: "Call Right -> InOrder(5)." },
            // NODE 5 (Leaf)
            { line: 1, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Running"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["4", "2"], text: "Is 5 null? No." },
            { line: 2, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Paused (L2)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"current"}, ghosts:["ghost-5-left"], output:["4", "2"], text: "5 calls Left (null). Return." },
            { line: 3, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Running"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["4", "2", "5"], text: "Print 5." },
            { line: 4, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Paused (L4)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"visited"}, ghosts:["ghost-5-right"], output:["4", "2", "5"], text: "5 calls Right (null). Return." },
            { line: 5, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Paused (L4)"},{f:"In", a:"5", s:"Returning"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5"], text: "Node 5 Done. Pop." },
            // FINISH 2
            { line: 5, stack: [{f:"In", a:"1", s:"Paused (L2)"},{f:"In", a:"2", s:"Returning"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5"], text: "Node 2 Done. Pop." },
            // BACK TO 1
            { line: 3, stack: [{f:"In", a:"1", s:"Running"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1"], text: "Back to Root (1). Print 1." },
            { line: 4, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 3:"current", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1"], text: "Call Right -> InOrder(3)." },
            // NODE 3 (Leaf)
            { line: 1, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 3:"current", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1"], text: "Is 3 null? No." },
            { line: 2, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Paused (L2)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 3:"current", 4:"visited", 5:"visited"}, ghosts:["ghost-3-left"], output:["4", "2", "5", "1"], text: "3 calls Left (null). Return." },
            { line: 3, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 3:"current", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1", "3"], text: "Print 3." },
            { line: 4, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Paused (L4)"},{f:"In", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 3:"visited", 4:"visited", 5:"visited"}, ghosts:["ghost-3-right"], output:["4", "2", "5", "1", "3"], text: "3 calls Right (null). Return." },
            { line: 5, stack: [{f:"In", a:"1", s:"Paused (L4)"},{f:"In", a:"3", s:"Returning"}], nodes: {1:"visited", 2:"visited", 3:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1", "3"], text: "Node 3 Done. Pop." },
            // FINISH 1
            { line: 5, stack: [{f:"In", a:"1", s:"Returning"}], nodes: {1:"visited", 2:"visited", 3:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1", "3"], text: "Root Done. Pop. Traversal Complete." },
            { line: -1, stack: [], nodes: {1:"visited", 2:"visited", 3:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "2", "5", "1", "3"], text: "Stack Empty. Finished." }
        ];

        const stepsPreOrder = [
             // START 1 (Root, Left, Right)
            { line: 0, stack: [{f:"Pre", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Start at Root (1)." },
            { line: 1, stack: [{f:"Pre", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Is 1 null? No." },
            { line: 2, stack: [{f:"Pre", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:["1"], text: "Print 1 (Root)." },
            { line: 3, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Running"}], nodes: {1:"visited", 2:"current"}, ghosts:[], output:["1"], text: "Call Left -> PreOrder(2)." },
            
            // NODE 2
            { line: 1, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Running"}], nodes: {1:"visited", 2:"current"}, ghosts:[], output:["1"], text: "Is 2 null? No." },
            { line: 2, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Running"}], nodes: {1:"visited", 2:"current"}, ghosts:[], output:["1", "2"], text: "Print 2." },
            { line: 3, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"current"}, ghosts:[], output:["1", "2"], text: "Call Left -> PreOrder(4)." },
            
            // NODE 4
            { line: 1, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"current"}, ghosts:[], output:["1", "2"], text: "Is 4 null? No." },
            { line: 2, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"current"}, ghosts:[], output:["1", "2", "4"], text: "Print 4." },
            { line: 3, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Paused (L3)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited"}, ghosts:["ghost-4-left"], output:["1", "2", "4"], text: "4 Calls Left (null). Return." },
            { line: 4, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Paused (L4)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited"}, ghosts:["ghost-4-right"], output:["1", "2", "4"], text: "4 Calls Right (null). Return." },
            { line: 5, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L3)"},{f:"Pre", a:"4", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited"}, ghosts:[], output:["1", "2", "4"], text: "Node 4 Done. Pop." },

            // BACK TO 2
            { line: 4, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["1", "2", "4"], text: "Back to 2. Call Right -> PreOrder(5)." },
            
            // NODE 5
            { line: 1, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["1", "2", "4"], text: "Is 5 null? No." },
            { line: 2, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"current"}, ghosts:[], output:["1", "2", "4", "5"], text: "Print 5." },
            { line: 3, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Paused (L3)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited"}, ghosts:["ghost-5-left"], output:["1", "2", "4", "5"], text: "5 calls Left (null). Return." },
            { line: 4, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Paused (L4)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited"}, ghosts:["ghost-5-right"], output:["1", "2", "4", "5"], text: "5 calls Right (null). Return." },
            { line: 5, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Paused (L4)"},{f:"Pre", a:"5", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["1", "2", "4", "5"], text: "Node 5 Done. Pop." },

            // FINISH 2, BACK TO 1
            { line: 5, stack: [{f:"Pre", a:"1", s:"Paused (L3)"},{f:"Pre", a:"2", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["1", "2", "4", "5"], text: "Node 2 Done. Pop." },
            { line: 4, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["1", "2", "4", "5"], text: "Back to 1. Call Right -> PreOrder(3)." },

            // NODE 3
            { line: 1, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["1", "2", "4", "5"], text: "Is 3 null? No." },
            { line: 2, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Running"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["1", "2", "4", "5", "3"], text: "Print 3." },
            { line: 3, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Paused (L3)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:["ghost-3-left"], output:["1", "2", "4", "5", "3"], text: "3 calls Left (null). Return." },
            { line: 4, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Paused (L4)"},{f:"Pre", a:"null", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:["ghost-3-right"], output:["1", "2", "4", "5", "3"], text: "3 calls Right (null). Return." },
            { line: 5, stack: [{f:"Pre", a:"1", s:"Paused (L4)"},{f:"Pre", a:"3", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["1", "2", "4", "5", "3"], text: "Node 3 Done. Pop." },

            // FINISH
            { line: 5, stack: [{f:"Pre", a:"1", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["1", "2", "4", "5", "3"], text: "Root Done. Pop." },
            { line: -1, stack: [], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["1", "2", "4", "5", "3"], text: "Stack Empty. Finished." }
        ];

        const stepsPostOrder = [
             // START 1 (Left, Right, Root)
            { line: 0, stack: [{f:"Post", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Start at Root (1)." },
            { line: 1, stack: [{f:"Post", a:"1", s:"Running"}], nodes: {1:"current"}, ghosts:[], output:[], text: "Is 1 null? No." },
            { line: 2, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Running"}], nodes: {1:"default", 2:"current"}, ghosts:[], output:[], text: "Call Left -> PostOrder(2)." },
            
            // NODE 2
            { line: 1, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Running"}], nodes: {1:"default", 2:"current"}, ghosts:[], output:[], text: "Is 2 null? No." },
            { line: 2, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:[], text: "Call Left -> PostOrder(4)." },
            
            // NODE 4
            { line: 1, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:[], text: "Is 4 null? No." },
            { line: 2, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Paused (L2)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:["ghost-4-left"], output:[], text: "4 calls Left (null). Return." },
            { line: 3, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Paused (L3)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:["ghost-4-right"], output:[], text: "4 calls Right (null). Return." },
            { line: 4, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Running"}], nodes: {1:"default", 2:"default", 4:"current"}, ghosts:[], output:["4"], text: "Print 4." },
            { line: 5, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L2)"},{f:"Post", a:"4", s:"Returning"}], nodes: {1:"default", 2:"default", 4:"visited"}, ghosts:[], output:["4"], text: "Node 4 Done. Pop." },

            // BACK TO 2
            { line: 3, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Running"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"current"}, ghosts:[], output:["4"], text: "Back to 2. Call Right -> PostOrder(5)." },

            // NODE 5
            { line: 1, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Running"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"current"}, ghosts:[], output:["4"], text: "Is 5 null? No." },
            { line: 2, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Paused (L2)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"current"}, ghosts:["ghost-5-left"], output:["4"], text: "5 calls Left (null). Return." },
            { line: 3, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Paused (L3)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"current"}, ghosts:["ghost-5-right"], output:["4"], text: "5 calls Right (null). Return." },
            { line: 4, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Running"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"current"}, ghosts:[], output:["4", "5"], text: "Print 5." },
            { line: 5, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Paused (L3)"},{f:"Post", a:"5", s:"Returning"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "5"], text: "Node 5 Done. Pop." },

            // BACK TO 2, PRINT 2
            { line: 4, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Running"}], nodes: {1:"default", 2:"current", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "5", "2"], text: "Back to 2. Print 2." },
            { line: 5, stack: [{f:"Post", a:"1", s:"Paused (L2)"},{f:"Post", a:"2", s:"Returning"}], nodes: {1:"default", 2:"visited", 4:"visited", 5:"visited"}, ghosts:[], output:["4", "5", "2"], text: "Node 2 Done. Pop." },

            // BACK TO 1
            { line: 3, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Running"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["4", "5", "2"], text: "Back to 1. Call Right -> PostOrder(3)." },
            
            // NODE 3
            { line: 1, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Running"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["4", "5", "2"], text: "Is 3 null? No." },
            { line: 2, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Paused (L2)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:["ghost-3-left"], output:["4", "5", "2"], text: "3 calls Left (null). Return." },
            { line: 3, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Paused (L3)"},{f:"Post", a:"null", s:"Returning"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:["ghost-3-right"], output:["4", "5", "2"], text: "3 calls Right (null). Return." },
            { line: 4, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Running"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"current"}, ghosts:[], output:["4", "5", "2", "3"], text: "Print 3." },
            { line: 5, stack: [{f:"Post", a:"1", s:"Paused (L3)"},{f:"Post", a:"3", s:"Returning"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["4", "5", "2", "3"], text: "Node 3 Done. Pop." },
            
            // FINISH 1
            { line: 4, stack: [{f:"Post", a:"1", s:"Running"}], nodes: {1:"current", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["4", "5", "2", "3", "1"], text: "Back to 1. Print 1." },
            { line: 5, stack: [{f:"Post", a:"1", s:"Returning"}], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["4", "5", "2", "3", "1"], text: "Root Done. Pop." },
            { line: -1, stack: [], nodes: {1:"visited", 2:"visited", 4:"visited", 5:"visited", 3:"visited"}, ghosts:[], output:["4", "5", "2", "3", "1"], text: "Finished." }
        ];

        let currentMode = 'inorder';
        let currentSteps = stepsInOrder;
        let currentCode = codes.inorder;
        let currentStepIndex = 0;

        function setMode(mode) {
            currentMode = mode;
            currentStepIndex = 0;
            
            // Update Data Refs
            if(mode === 'inorder') {
                currentSteps = stepsInOrder;
                currentCode = codes.inorder;
                document.getElementById('code-label').innerText = 'C++ InOrder Implementation';
            } else if(mode === 'preorder') {
                currentSteps = stepsPreOrder;
                currentCode = codes.preorder;
                document.getElementById('code-label').innerText = 'C++ PreOrder Implementation';
            } else {
                currentSteps = stepsPostOrder;
                currentCode = codes.postorder;
                document.getElementById('code-label').innerText = 'C++ PostOrder Implementation';
            }

            // Update UI State
            ['inorder', 'preorder', 'postorder'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if(m === mode) {
                    btn.className = "px-4 py-1.5 rounded text-sm font-medium transition bg-slate-700 text-white shadow-sm";
                } else {
                    btn.className = "px-4 py-1.5 rounded text-sm font-medium transition text-slate-400 hover:text-white";
                }
            });

            updateAll();
        }

        // --- RENDERERS ---

        function renderCode() {
            const container = document.getElementById('code-container');
            container.innerHTML = '';
            
            currentCode.forEach((text, index) => {
                const div = document.createElement('div');
                const isHighlighted = (index === currentSteps[currentStepIndex].line);
                div.className = `code-line px-2 py-1 rounded text-slate-400 border-l-4 border-transparent ${
                    isHighlighted ? 'bg-blue-900/40 text-blue-100 border-blue-500 font-bold' : ''
                }`;
                
                // Syntax highlighting
                let html = text
                    .replace("void", "<span class='text-purple-400'>void</span>")
                    .replace("if", "<span class='text-purple-400'>if</span>")
                    .replace("return", "<span class='text-purple-400'>return</span>")
                    .replace("Node*", "<span class='text-yellow-400'>Node*</span>")
                    .replace("cout", "<span class='text-blue-300'>cout</span>")
                    .replace("nullptr", "<span class='text-purple-300'>nullptr</span>");
                
                div.innerHTML = `<span class="inline-block w-6 text-slate-700 text-xs select-none">${index+1}</span> ${html}`;
                container.appendChild(div);
            });
        }

        function renderTree() {
            const state = currentSteps[currentStepIndex];
            
            // Nodes (1, 2, 3, 4, 5)
            [1, 2, 3, 4, 5].forEach(id => {
                const el = document.getElementById(`node-${id}`);
                const status = state.nodes[id] || "default";
                
                // Reset colors (brute force clear)
                el.className = `absolute -translate-x-1/2 -translate-y-1/2 w-14 h-14 border-2 rounded-full flex items-center justify-center text-lg font-bold shadow-lg z-10 transition-colors duration-300`;
                
                // Re-add position classes based on ID (Hardcoded for simplicity in this update)
                if(id===1) el.classList.add('top-[15%]', 'left-[50%]');
                if(id===2) el.classList.add('top-[40%]', 'left-[30%]');
                if(id===3) el.classList.add('top-[40%]', 'left-[70%]');
                if(id===4) el.classList.add('top-[65%]', 'left-[15%]');
                if(id===5) el.classList.add('top-[65%]', 'left-[45%]');

                if (status === 'current') {
                    el.classList.add('bg-slate-800', 'border-red-500', 'text-red-400', 'node-current', 'z-20');
                } else if (status === 'visited') {
                    el.classList.add('bg-green-900', 'border-green-600', 'text-green-100');
                } else {
                    el.classList.add('bg-slate-800', 'border-slate-600', 'text-slate-200');
                }
            });

            // Ghosts (Nulls)
            document.querySelectorAll('[id^="ghost-"]').forEach(el => el.classList.remove('opacity-100'));
            state.ghosts.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('opacity-100');
            });
        }

        function renderStack() {
            const container = document.getElementById('stack-container');
            const stackData = currentSteps[currentStepIndex].stack;

            container.innerHTML = '';

            if (stackData.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.id = 'empty-stack-msg';
                emptyDiv.className = 'text-center text-slate-600 text-sm mt-10 italic';
                emptyDiv.innerText = 'Stack is empty';
                container.appendChild(emptyDiv);
                return;
            }

            // Create visual stack frames
            stackData.forEach((frame, idx) => {
                const isTop = idx === stackData.length - 1;
                const div = document.createElement('div');
                div.className = `stack-frame p-3 rounded border shadow-sm ${
                    isTop 
                        ? (frame.s === 'Returning' ? 'bg-red-900/30 border-red-700' : 'bg-blue-600 border-blue-400 stack-active') 
                        : 'bg-slate-700 border-slate-600 opacity-60'
                }`;
                
                // For code line display in stack
                const lineNumDisplay = frame.s.includes('L') 
                    ? frame.s.split('(')[1].replace(')', '') 
                    : (isTop ? currentSteps[currentStepIndex].line + 1 : '?');

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm ${isTop ? 'text-white' : 'text-slate-300'}">${frame.f}(${frame.a})</span>
                        <span class="text-[10px] uppercase tracking-wider ${isTop ? 'text-blue-200' : 'text-slate-400'}">
                            Line ${lineNumDisplay}
                        </span>
                    </div>
                    <div class="text-xs ${isTop ? 'text-blue-100' : 'text-slate-400'}">
                        ${frame.s}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderControls() {
            document.getElementById('step-counter').innerText = `${currentStepIndex + 1} / ${currentSteps.length}`;
            const progress = ((currentStepIndex + 1) / currentSteps.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            document.getElementById('btn-prev').disabled = currentStepIndex === 0;
            document.getElementById('btn-next').disabled = currentStepIndex === currentSteps.length - 1;
            
            // Console Output
            const outputContainer = document.getElementById('console-output');
            const outputArr = currentSteps[currentStepIndex].output;
            outputContainer.innerHTML = outputArr.map(n => `<span class="text-green-400 font-bold">${n}</span>`).join(' ') + '<span class="animate-pulse ml-1">_</span>';
            
            // Text Explanation
            document.getElementById('explanation-text').innerText = currentSteps[currentStepIndex].text;
        }

        function updateAll() {
            renderCode();
            renderTree();
            renderStack();
            renderControls();
        }

        // --- EVENT LISTENERS ---

        document.getElementById('btn-next').addEventListener('click', () => {
            if (currentStepIndex < currentSteps.length - 1) {
                currentStepIndex++;
                updateAll();
            }
        });

        document.getElementById('btn-prev').addEventListener('click', () => {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                updateAll();
            }
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            currentStepIndex = 0;
            updateAll();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') document.getElementById('btn-next').click();
            if (e.key === 'ArrowLeft') document.getElementById('btn-prev').click();
        });

        // Initialize
        updateAll();

    </script>
</body>
</html>